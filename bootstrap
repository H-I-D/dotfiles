#!/bin/bash -eu
# consts
# --------------
DOT_HOME=~/dotfiles
REMOTE_URL="git@github.com:H-I-D/dotfiles.git"
if which tput >/dev/null 2>&1; then
  ncolors=$(tput colors)
fi
if [ -t 1 ] && [ -n "$ncolors" ] && [ "$ncolors" -ge 8 ]; then
  RED="$(tput setaf 1)"
  GREEN="$(tput setaf 2)"
  YELLOW="$(tput setaf 3)"
  BLUE="$(tput setaf 4)"
  BOLD="$(tput bold)"
  NORMAL="$(tput sgr0)"
else
  RED=""
  GREEN=""
  YELLOW=""
  BLUE=""
  BOLD=""
  NORMAL=""
fi
# functions
# --------------
has() {
  type "$1" > /dev/null 2>&1
}

usage() {
  name=`basename $0`
  echo $BLUE
  cat <<\EOF

                   __          __       ___      ___
                  /\ \        /\ \__  /'___\ __ /\_ \
                  \_\ \    ___\ \ ,_\/\ \__//\_\\//\ \      __    ____
 _______          /'_` \  / __`\ \ \/\ \ ,__\/\ \ \ \ \   /'__`\ /',__\      _______
/\______\      __/\ \L\ \/\ \L\ \ \ \_\ \ \_/\ \ \ \_\ \_/\  __//\__, `\    /\______\
\/______/     /\_\ \___,_\ \____/\ \__\\ \_\  \ \_\/\____\ \____\/\____/    \/______/
              \/_/\/__,_ /\/___/  \/__/ \/_/   \/_/\/____/\/____/\/___/
EOF
  echo $YELLOW
  cat <<\EOF
note:
Please make sure that you have completed adding ssh key to GitHub.
EOF
  echo $BLUE
  cat <<\EOF
Commands:
  init (download dotfiles)
  deploy (symlink dotfiles)
EOF
  echo $NORMAL
}

download() {
  if [ ! -d ${DOT_HOME} ]; then
    echo "Downloading dotfiles..."
    mkdir ${DOT_HOME}
    # install oh-my-zsh
    # sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
    # install vim-plug
    # curl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    if has "git"; then
      git clone --recursive "${REMOTE_URL}" "${DOT_HOME}"
    else
      echo "${RED}Please install git.${NORMAL}"
      exit 1
    fi
    echo "${GREEN}Successfully download dotfiles. ✔︎ ${NORMAL}"
  fi
}

symlink_files() {
  echo "Symlinking dotfiles..."
  for f in .??*
  do
    # ignore list
    [[ ${f} = ".DS_Store" ]] && continue
    [[ ${f} = ".git" ]] && continue
    [[ ${f} = ".gitignore" ]] && continue
    [[ ${f} = ".gitmodules" ]] && continue
    [[ ${f} = ".brewfile" ]] && continue
    # symlink files
    ln -snfv ${DOT_HOME}/${f} ${HOME}/${f}
  done
  echo "${GREEN}Successfully symlink dotfiles. ✔︎ ${NORMAL}"
  echo "${BOLD}To enable zsh, please execute 'chsh -s /path/to/zsh'.${NORMAL}"
}

# main
# --------------
usage
echo -n "${BOLD}command: ${NORMAL}"
read command
case $command in
  init)
    download
    ;;
  deploy)
    symlink_files
    ;;
  *)
    echo "${RED}bootstrap: command not found.${NORMAL}"
    exit 1
    ;;
esac

exit 0
